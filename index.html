<!DOCTYPE html>
<html lang="ru">
  <head>
    <title>Мой Mini App</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* Ваши стили */
    </style>
  </head>
  <body>
    <div id="content"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const tg = window.Telegram.WebApp;

        if (tg) {
          tg.expand();
          tg.ready();

          const contentDiv = document.getElementById("content");
          let currentPage = 1;

          function showMenu() {
            const menuButtons = [
              { text: "События", callback: () => loadData(0) },
              { text: "Анонсы", callback: () => loadData(1) },
              { text: "Объявления", callback: () => loadData(2) },
              { text: "О нас", callback: () => loadData(3) },
              { text: "Блог", callback: () => loadData(4) },
            ];

            let menuHTML = "";
            menuButtons.forEach((button) => {
              menuHTML += `<button onclick="${button.callback}">${button.text}</button>`;
            });

            contentDiv.innerHTML = menuHTML;
          }

          async function loadData(category) {
            let response;
            if (category === 3) {
              response = await fetch("/about_us");
            } else {
              response = await fetch(
                `/data?category=${category}&page=${currentPage}`
              );
            }

            const data = await response.json(); //  Получаем данные в формате JSON

            let contentHTML = "";

            if (category in [0, 1, 2, 4]) {
              data.forEach((item, index) => {
                const decodedItem = item.map((str) => JSON.parse(`"${str}"`)); // Декодируем каждый элемент массива
                contentHTML += `<div>
                             <h3>${decodedItem[1]}</h3>
                             <p>${decodedItem[0]}</p>
                             <button onclick="showDetails(${category}, ${index})">Подробнее</button>
                           </div>`;
              });
              contentHTML += `<button onclick="prevPage(${category})" ${
                currentPage === 1 ? "disabled" : ""
              }>Назад</button>`;
              contentHTML += `<button onclick="nextPage(${category})">Далее</button>`;
            } else if (category === 3) {
              data.forEach((item) => {
                const decodedItem = JSON.parse(`"${item}"`); // Декодируем элемент
                contentHTML += `<button onclick="showAboutUsDetails('${decodedItem}')">${decodedItem}</button>`;
              });
            }
            contentDiv.innerHTML = contentHTML;
          }

          async function showDetails(category, index) {
            const response = await fetch(
              `/data?category=${category}&page=${currentPage}`
            );
            const data = await response.json();
            const item = data[index].map((str) => JSON.parse(`"${str}"`)); // Декодируем каждый элемент массива
            contentDiv.innerHTML = `<p>${item[2]}</p><button onclick="loadData(${category})">Назад</button>`;
          }

          async function showAboutUsDetails(title) {
            let detailText = "";
            if (title === "О нас") {
              detailText = await (
                await fetch("/about_us_details?section=0")
              ).text();
            } else if (title === "Клуб по интересам") {
              detailText = await (
                await fetch("/about_us_details?section=1")
              ).text();
            } else if (title === "Информация") {
              detailText = await (
                await fetch("/about_us_details?section=2")
              ).text();
            }

            contentDiv.innerHTML = `<p>${detailText}</p><button onclick="loadData(3)">Назад</button>`;
          }

          function prevPage(category) {
            if (currentPage > 1) {
              currentPage--;
              loadData(category);
            }
          }

          function nextPage(category) {
            currentPage++;
            loadData(category);
          }

          async function sendNotification(userId, message) {
            const response = await fetch("/send_notification", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: userId, message: message }),
            });

            const data = await response.json();
            console.log(data);
          }

          showMenu();
          const userId = tg.initDataUnsafe.user.id;
          sendNotification(userId, "Привет из Mini App!");
        } else {
          document.body.innerHTML =
            "<p>Ошибка: Telegram WebApp недоступен.</p>";
        }
      });
    </script>
  </body>
</html>
